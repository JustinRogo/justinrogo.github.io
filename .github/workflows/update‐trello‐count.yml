name: Update Trello Card Count

on:
  schedule:
    - cron: '0 * * * *'      # run at the top of every hour
  workflow_dispatch:        # allow manual â€œRun workflowâ€ in the Actions UI

permissions:
  contents: write           # let us push commits back

jobs:
  update-count:
    runs-on: ubuntu-latest

    steps:
      # 1) Check out your default branch in a fully-populated repo
      - name: Checkout main
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      # 2) Curl Trello for just the IDs, then count them
      - name: Fetch & count cards
        id: cardcount
        env:
          KEY:   ${{ secrets.TRELLO_KEY }}
          TOKEN: ${{ secrets.TRELLO_TOKEN }}
          BOARD: 0YERXDTw
        run: |
          COUNT=$(curl -s \
            "https://api.trello.com/1/boards/${BOARD}/cards?key=${KEY}&token=${TOKEN}&fields=id" \
            | jq length)
          echo "cards_count=$COUNT" >> $GITHUB_OUTPUT

      # 3) Write out a tiny JSON file in a /data folder
      - name: Write JSON
        run: |
          mkdir -p data
          echo "{\"count\":${{ steps.cardcount.outputs.cards_count }}}" \
            > data/cards_count.json

      # 4) Commit & push it back to main
      - name: Commit & push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/cards_count.json
          git commit -m "chore: update Trello card count" || echo "ðŸ”„ no changes to commit"
          git push origin main
