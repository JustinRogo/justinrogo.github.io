name: Update Trello Card Count

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-count:
    runs-on: windows-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure data folder exists
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path data -Force

      - name: Fetch & count cards
        id: cardcount
        shell: pwsh
        env:
          TRELLO_KEY:   ${{ secrets.TRELLO_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
          BOARD:        0YERXDTw
        run: |
          # 1) Get all cards with their dueComplete flag
          $url    = "https://api.trello.com/1/boards/$env:BOARD/cards?fields=id,dueComplete&key=$env:TRELLO_KEY&token=$env:TRELLO_TOKEN"
          $cards  = Invoke-RestMethod -Uri $url -Method Get

          # 2) Compute totals
          $total     = $cards.Count
          $completed = ($cards | Where-Object { $_.dueComplete -eq $true }).Count

          # 3) Export both as step outputs
          "cards_count=$total"     | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8
          "completed_count=$completed" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Write JSON
        shell: pwsh
        run: |
          # Build a JSON object with both values
          $json = @{
            total_count     = ${{ steps.cardcount.outputs.cards_count }}
            completed_count = ${{ steps.cardcount.outputs.completed_count }}
          } | ConvertTo-Json

          # Overwrite the file in data/
          $json | Set-Content -Path data/cards_count.json -Encoding utf8

      - name: Commit & push
        shell: pwsh
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/cards_count.json
          if (-not (git diff --cached --quiet)) {
            git commit -m "chore: update Trello card counts"
            git push origin main
          } else {
            Write-Host "No changes to commit"
          }
