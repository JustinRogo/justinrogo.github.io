name: Update Trello Card Count

on:
  schedule:
    - cron: '0 * * * *'    # every hour
  workflow_dispatch:      # allows manual runs

# 1) Grant write access so the built-in GITHUB_TOKEN can push
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 2) Checkout your default branch, not just a detached commit
      - name: Check out code
        uses: actions/checkout@v3
        with:
          ref: main            # <-- change if your Pages lives on a different branch
          fetch-depth: 0       # full history so git can set upstream
          persist-credentials: true

      - name: Fetch card count
        id: count
        env:
          KEY:   ${{ secrets.TRELLO_KEY }}
          TOKEN: ${{ secrets.TRELLO_TOKEN }}
          BOARD: 0YERXDTw
        run: |
          COUNT=$(curl -s \
            "https://api.trello.com/1/boards/${BOARD}/cards?key=${KEY}&token=${TOKEN}&fields=id" \
            | jq length)
          echo "cards_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Write count to JSON
        run: |
          mkdir -p docs/data
          echo "{\"count\": ${{ steps.count.outputs.cards_count }}}" \
            > docs/data/cards_count.json

      - name: Commit & push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # ensure weâ€™re on the branch
          git checkout main  
          git add docs/data/cards_count.json
          git commit -m "chore: update Trello card count" || echo "ðŸ”„ no changes"
          # explicitly push to origin/main
          git push origin main
