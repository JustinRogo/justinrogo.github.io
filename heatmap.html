<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Occupancy Heatmap | Dashboard</title>
    <style>
        :root {
            /* Modern Dark Palette */
            --bg-body: #0f172a;       /* Slate 900 */
            --bg-panel: rgba(30, 41, 59, 0.85); /* Slate 800 with alpha */
            --bg-element: #334155;    /* Slate 700 */
            --primary: #3b82f6;       /* Blue 500 */
            --primary-hover: #2563eb; /* Blue 600 */
            --danger: #ef4444;        /* Red 500 */
            --text-main: #f1f5f9;     /* Slate 100 */
            --text-muted: #94a3b8;    /* Slate 400 */
            --border: #1e293b;        /* Slate 800 */
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent body scroll, handle inside wrap */
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 20;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0; /* allows flex children to shrink */
        }

        .logo-area {
            font-weight: 700;
            font-size: 1.1rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }
        
        .stat-badge {
            background: var(--bg-element);
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.9rem;
            color: var(--text-main);
            border: 1px solid var(--border);
            white-space: nowrap;
        }

        /* --- Scrollable Tabs --- */
        .tabs-container {
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE */
            mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent);
        }
        .tabs-container::-webkit-scrollbar { display: none; }

        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0 10px;
        }

        .tab {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
        }

        .tab.active {
            background: var(--bg-element);
            color: var(--primary);
            border-color: var(--border);
            box-shadow: var(--shadow);
        }

        .tab .badge {
            background: rgba(0,0,0,0.3);
            font-size: 0.75rem;
            padding: 0.1rem 0.4rem;
            border-radius: 99px;
            color: var(--text-muted);
        }
        .tab.active .badge {
            background: var(--primary);
            color: white;
        }

        /* --- Main Canvas Area --- */
        #wrap {
            position: relative;
            flex: 1;
            background-image: radial-gradient(var(--bg-element) 1px, transparent 1px);
            background-size: 20px 20px; /* Grid pattern effect */
            overflow: hidden;
            touch-action: none;
            cursor: crosshair;
        }

        #floor, #heat {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: block;
        }
        #heat { pointer-events: none; }

        /* --- Footer / Controls --- */
        footer {
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: grid;
            grid-template-columns: auto 1fr auto; /* Tools | Notes | Submit */
            gap: 1rem;
            align-items: center;
            z-index: 20;
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
        }

        /* Buttons */
        button {
            border: 1px solid var(--border);
            background: var(--bg-element);
            color: var(--text-main);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover:not(:disabled) {
            background: #475569;
        }
        button:active:not(:disabled) {
            transform: scale(0.97);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.icon-only {
            padding: 0.6rem;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* Submit Button Special Styling */
        .submitbtn {
            background: var(--primary);
            border-color: var(--primary-hover);
            color: white;
            font-weight: 600;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        .submitbtn:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        /* Textarea styling */
        .notes-wrap {
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
        }
        
        #notes {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 8px;
            padding: 0.6rem;
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            width: 100%;
            height: 42px; /* Compact by default */
            transition: height 0.2s, border-color 0.2s;
        }
        #notes:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0,0,0,0.3);
            height: 80px; /* Expands on focus */
            position: absolute;
            bottom: 0;
            z-index: 30;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }

        /* --- Settings Panel --- */
        .panel {
            position: fixed;
            top: 70px;
            right: 1rem;
            width: 300px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(12px);
            z-index: 50;
            transform-origin: top right;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .panel[hidden] {
            display: flex !important; /* Override default hidden display */
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        .panel h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .control-row {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .control-row label {
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
        }
        
        /* Custom Range Inputs */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: var(--bg-element);
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--primary);
            margin-top: -5px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        /* File Inputs */
        input[type="file"] {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        input[type="file"]::file-selector-button {
            border: 1px solid var(--border);
            background: var(--bg-element);
            color: var(--text-main);
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        /* --- Mobile Tweaks --- */
        @media (max-width: 768px) {
            footer {
                grid-template-columns: 1fr 1fr; /* Two columns */
                grid-template-areas: 
                    "tools submit"
                    "notes notes";
            }
            .toolbar-group { grid-area: tools; }
            .submitbtn { grid-area: submit; width: 100%; }
            .notes-wrap { grid-area: notes; margin-top: 0.5rem; }
            
            #notes:focus {
                position: static; /* Don't pop up on mobile, keeps flow */
                height: 60px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-left">
            <button id="menuBtn" type="button" class="icon-only" aria-label="Menu" aria-expanded="false" aria-controls="controlsPanel">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            
            <div class="tabs-container">
                <div class="tabs" id="tabs"></div>
            </div>
        </div>

        <div class="stat-badge">
            Total: <strong id="totalCount" style="color: var(--primary); margin-left:4px;">0</strong>
        </div>
    </header>

    <div id="wrap">
        <canvas id="floor"></canvas>
        <canvas id="heat"></canvas>
    </div>

    <footer>
        <div class="toolbar-group">
            <button id="undo" disabled title="Undo last point">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                Undo
            </button>
            <button id="clear" disabled title="Clear points on this floor">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                Clear
            </button>
        </div>

        <div class="notes-wrap">
            <textarea id="notes" placeholder="Add optional notes here..."></textarea>
        </div>

        <button id="submit" class="submitbtn">
            Submit
            <span id="status" style="font-weight: 400; font-size: 0.8em; opacity: 0.8;"></span>
        </button>
    </footer>

    <div id="controlsPanel" class="panel" hidden>
        <h3>Visualization</h3>
        <div class="control-row">
            <label>Radius <span id="val-radius">50</span></label>
            <input id="radius" type="range" min="8" max="80" value="50" oninput="document.getElementById('val-radius').innerText=this.value">
        </div>
        <div class="control-row">
            <label>Intensity <span id="val-inten">150</span></label>
            <input id="intensity" type="range" min="5" max="200" value="150" oninput="document.getElementById('val-inten').innerText=this.value">
        </div>
        <div class="control-row">
            <label>Opacity <span id="val-opac">80%</span></label>
            <input id="opacity" type="range" min="10" max="100" value="80" oninput="document.getElementById('val-opac').innerText=this.value+'%'">
        </div>
        <div class="control-row">
            <label>Blur <span id="val-blur">8px</span></label>
            <input id="blur" type="range" min="0" max="30" value="8" oninput="document.getElementById('val-blur').innerText=this.value+'px'">
        </div>

        <h3>Data Management</h3>
        <div class="control-row">
            <button id="resetAll" style="width:100%; border-color:var(--danger); color:var(--danger);">Reset All Floors</button>
        </div>
        
        <h3>Load History</h3>
        <div class="control-row">
            <label>Single JSON</label>
            <input id="loadJSON" type="file" accept="application/json">
        </div>
        <div class="control-row">
            <label>Trend Analysis (Batch)</label>
            <input id="loadMany" type="file" accept="application/json" multiple>
        </div>
        
        <div class="control-row">
            <label>Filter Start</label>
            <input id="from" type="datetime-local" style="background:var(--bg-body); border:1px solid var(--border); color:white; padding:4px; border-radius:4px;">
        </div>
        <div class="control-row">
            <label>Filter End</label>
            <input id="to" type="datetime-local" style="background:var(--bg-body); border:1px solid var(--border); color:white; padding:4px; border-radius:4px;">
        </div>
        <div class="control-row" style="flex-direction:row; align-items:center;">
             <input id="includeSessions" type="checkbox" checked style="width:auto;">
             <label for="includeSessions" style="margin-left:0.5rem; margin-bottom:0;">Include loaded sessions</label>
        </div>
    </div>

    <script>
        (() => {
            // --- Embedded floor images (replace placeholders) ------------------------
            const EMBEDDED = {
                '1F': 'https://raw.githubusercontent.com/JustinRogo/justinrogo.github.io/refs/heads/main/Maps/1F.png',
                '2F': 'https://raw.githubusercontent.com/JustinRogo/justinrogo.github.io/refs/heads/main/Maps/2F.png',
                '3F': 'https://raw.githubusercontent.com/JustinRogo/justinrogo.github.io/refs/heads/main/Maps/3F.png',
                '4F': 'https://raw.githubusercontent.com/JustinRogo/justinrogo.github.io/refs/heads/main/Maps/4F.png',
                '5F': 'https://raw.githubusercontent.com/JustinRogo/justinrogo.github.io/refs/heads/main/Maps/5F.png',
            };

            // --- Floors ---------------------------------------------------------------
            const FLOORS = [
                { id: '1F', label: '1st Floor', img: new Image(), imgSrc: null, points: [] },
                { id: '2F', label: '2nd Floor', img: new Image(), imgSrc: null, points: [] },
                { id: '3F', label: '3rd Floor', img: new Image(), imgSrc: null, points: [] },
                { id: '4F', label: '4th Floor', img: new Image(), imgSrc: null, points: [] },
                { id: '5F', label: '5th Floor', img: new Image(), imgSrc: null, points: [] },
            ];
            let current = 0;

            // Sessions loaded for trend review
            const SESSIONS = []; 

            // --- Elements -------------------------------------------------------------
            const wrap = document.getElementById('wrap');
            const floor = document.getElementById('floor');
            const heat = document.getElementById('heat');
            const fctx = floor.getContext('2d');
            const hctx = heat.getContext('2d');
            const undoBtn = document.getElementById('undo');
            const clearBtn = document.getElementById('clear');
            const resetAll = document.getElementById('resetAll');
            const submitBtn = document.getElementById('submit');
            const statusEl = document.getElementById('status');
            const radiusEl = document.getElementById('radius');
            const intenEl = document.getElementById('intensity');
            const opacEl = document.getElementById('opacity');
            const blurEl = document.getElementById('blur');
            const loadJSON = document.getElementById('loadJSON');
            const loadMany = document.getElementById('loadMany');
            const fromEl = document.getElementById('from');
            const toEl = document.getElementById('to');
            const includeSessionsEl = document.getElementById('includeSessions');
            const notesEl = document.getElementById('notes');
            const FLOW_URL = "https://default17f1a87e2a254eaab9df9d439034b0.80.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8a4d2abd61de4fceb5cb6d2a4b2b31a8/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EhX0b_ECMsXs08oSiwPJKO3H5KMRI3O0l3V1lLtdM6Q";

            // Tabs with counters
            const tabs = document.getElementById('tabs');
            FLOORS.forEach((fl, i) => {
                const b = document.createElement('button');
                b.className = 'tab' + (i === 0 ? ' active' : '');
                // Using div to allow flex styling
                b.innerHTML = `<span>${fl.label}</span> <span class="badge" id="count-${fl.id}">0</span>`;
                b.onclick = () => { current = i; updateTabs(); fitCanvas(); redraw(); };
                tabs.appendChild(b);
            });
            function updateTabs() {
                tabs.querySelectorAll('.tab').forEach((el, idx) => {
                    el.classList.toggle('active', idx === current);
                    // scroll into view if needed
                    if (idx === current) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });
            }

            // Preload embedded images
            FLOORS.forEach(fl => {
                if (EMBEDDED[fl.id]) {
                    fl.imgSrc = EMBEDDED[fl.id];
                    fl.img.src = EMBEDDED[fl.id];
                }
                fl.img.onload = () => { if (FLOORS[current] === fl) { fitCanvas(); redraw(); } persist(); };
            });

            // Resize handling
            window.addEventListener('resize', () => { fitCanvas(); redraw(); });

            // Input: only inside fitted image rect
            wrap.addEventListener('pointerdown', e => {
                const fl = FLOORS[current];
                if (!fl.img.naturalWidth) return;
                const rect = floor.getBoundingClientRect();
                const px = e.clientX - rect.left, py = e.clientY - rect.top;

                const fit = imageFitRect(fl.img.naturalWidth, fl.img.naturalHeight, floor.width, floor.height);
                if (px < fit.x || px > fit.x + fit.w || py < fit.y || py > fit.y + fit.h) return;

                const x = (px - fit.x) * (fl.img.naturalWidth / fit.w);
                const y = (py - fit.y) * (fl.img.naturalHeight / fit.h);

                fl.points.push({ x, y, t: Date.now() });
                persist(); redraw();
            });

            undoBtn.onclick = () => { FLOORS[current].points.pop(); persist(); redraw(); };
            clearBtn.onclick = () => { FLOORS[current].points = []; persist(); redraw(); };

            resetAll.onclick = () => {
                if(confirm("Are you sure you want to clear all data from ALL floors?")) {
                    FLOORS.forEach(fl => fl.points = []);
                    persist(); redraw();
                }
            };

            async function sendToFlow(payload) {
                const r = await fetch(FLOW_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (!r.ok) throw new Error(`${r.status} ${await r.text().catch(() => "")}`);
                return r; 
            }

            submitBtn.onclick = async () => {
                const payload = {
                    submitted_at: new Date().toISOString(),
                    note: (notesEl?.value || "").trim(),
                    floors: FLOORS.map(fl => ({
                        id: fl.id,
                        image_data_url: fl.img.naturalWidth ? fl.img.src : null,
                        image_size: fl.img.naturalWidth ? { w: fl.img.naturalWidth, h: fl.img.naturalHeight } : null,
                        points: fl.points
                    })),
                    TotalCount: computeTotalCount()
                };

                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                statusEl.textContent = " (Sending...)";
                
                try {
                    await sendToFlow(payload);
                    statusEl.textContent = " (Done!)";
                    
                    // Visual feedback success
                    submitBtn.style.background = "#10b981"; // Green
                    setTimeout(() => {
                        submitBtn.style.background = ""; // Reset
                        statusEl.textContent = "";
                        submitBtn.disabled = false;
                    }, 2000);

                    // reset points only
                    FLOORS.forEach(fl => fl.points = []);
                    persist(); redraw();

                    // clear note
                    if (notesEl) notesEl.value = "";
                } catch (e) {
                    statusEl.textContent = " Error";
                    alert(`Flow error: ${e.message}`);
                    submitBtn.disabled = false;
                }
            };

            // Load a single JSON
            loadJSON.onchange = e => {
                const [f] = e.target.files || [];
                if (!f) return;
                f.text().then(txt => {
                    try {
                        const data = JSON.parse(txt);
                        if (!data.floors) throw new Error("Bad format");
                        data.floors.forEach((fl, i) => {
                            if (!FLOORS[i]) return;
                            FLOORS[i].points = Array.isArray(fl.points) ? fl.points : [];
                            if (fl.image_data_url) { FLOORS[i].imgSrc = fl.image_data_url; FLOORS[i].img.src = fl.image_data_url; }
                        });
                        current = 0; updateTabs(); fitCanvas(); redraw();
                        alert(`Loaded ${f.name}`);
                    } catch (err) { alert("Invalid JSON file"); console.error(err); }
                });
            };

            // Load many JSONs
            loadMany.onchange = async e => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;
                const texts = await Promise.all(files.map(f => f.text()));
                for (const t of texts) {
                    try {
                        const j = JSON.parse(t);
                        if (!j.floors) continue;
                        const ts = j.submitted_at ? new Date(j.submitted_at) : new Date();
                        SESSIONS.push({ ts, floors: j.floors });
                    } catch { }
                }
                const min = new Date(Math.min(...SESSIONS.map(s => +s.ts)));
                const max = new Date(Math.max(...SESSIONS.map(s => +s.ts)));
                if (isFinite(+min) && isFinite(+max)) { fromEl.value = toLocalDT(min); toEl.value = toLocalDT(max); }
                redraw();
            };
            
            // Listeners for sliders that trigger redraw
            [radiusEl, intenEl, opacEl, blurEl].forEach(el => el.addEventListener('input', redraw));
            [fromEl, toEl, includeSessionsEl].forEach(el => el.addEventListener('input', redraw));

            // --- Helpers --------------------------------------------------------------
            function computeTotalCount() {
                let total = 0;
                FLOORS.forEach(fl => {
                    let n = fl.points.length;
                    for (const sess of filteredSessions()) {
                        const sf = (sess.floors || []).find(f => f.id === fl.id);
                        if (sf && Array.isArray(sf.points)) n += sf.points.length;
                    }
                    total += n;
                });
                return total;
            }

            function fitCanvas() {
                const rect = wrap.getBoundingClientRect();
                floor.width = Math.max(1, Math.floor(rect.width));
                floor.height = Math.max(1, Math.floor(rect.height));
                heat.width = floor.width; heat.height = floor.height;
                fctx.imageSmoothingEnabled = true;
                fctx.imageSmoothingQuality = 'high';
            }

            function imageFitRect(iw, ih, cw, ch) {
                if (!iw || !ih || !cw || !ch) return { x: 0, y: 0, w: cw, h: ch };
                const s = Math.min(cw / iw, ch / ih);
                const w = Math.floor(iw * s), h = Math.floor(ih * s);
                const x = Math.floor((cw - w) / 2), y = Math.floor((ch - h) / 2);
                return { x, y, w, h };
            }

            function filteredSessions() {
                if (!includeSessionsEl.checked) return [];
                const start = fromEl.value ? new Date(fromEl.value) : new Date(-8640000000000000);
                const end = toEl.value ? new Date(toEl.value) : new Date(8640000000000000);
                return SESSIONS.filter(s => s.ts >= start && s.ts <= end);
            }

            function redraw() {
                const fl = FLOORS[current];

                const aggPoints = [...fl.points];
                for (const sess of filteredSessions()) {
                    const sf = (sess.floors || []).find(f => f.id === fl.id);
                    if (sf && Array.isArray(sf.points)) aggPoints.push(...sf.points);
                }

                undoBtn.disabled = fl.points.length === 0;
                clearBtn.disabled = fl.points.length === 0;

                fctx.clearRect(0, 0, floor.width, floor.height);
                hctx.clearRect(0, 0, heat.width, heat.height);

                if (!fl.img.naturalWidth) { updateCounts(); return; }

                const fit = imageFitRect(fl.img.naturalWidth, fl.img.naturalHeight, floor.width, floor.height);
                fctx.drawImage(fl.img, 0, 0, fl.img.naturalWidth, fl.img.naturalHeight, fit.x, fit.y, fit.w, fit.h);

                const down = 0.5;
                const hw = Math.max(1, (fit.w * down) | 0);
                const hh = Math.max(1, (fit.h * down) | 0);
                const acc = document.createElement('canvas'); acc.width = hw; acc.height = hh;
                const actx = acc.getContext('2d', { willReadFrequently: true });
                actx.clearRect(0, 0, hw, hh);
                actx.globalCompositeOperation = 'lighter';

                const R = +radiusEl.value, I = +intenEl.value, k = down;

                const spr = makeKernelSprite(R);
                const sR = Math.max(2, Math.round(R * k));
                const sprScaled = document.createElement('canvas');
                sprScaled.width = sR * 2; sprScaled.height = sR * 2;
                sprScaled.getContext('2d').drawImage(spr, 0, 0, sprScaled.width, sprScaled.height);

                const iw = fl.img.naturalWidth, ih = fl.img.naturalHeight;
                const sx = fit.w / iw, sy = fit.h / ih;

                for (const p of aggPoints) {
                    const x = p.x * sx * k;
                    const y = p.y * sy * k;
                    actx.globalAlpha = Math.min(1, I / 100);
                    actx.drawImage(sprScaled, x - sR, y - sR);
                }

                const imgData = actx.getImageData(0, 0, hw, hh);
                const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const a = data[i + 3] / 255;
                    const [r, g, b] = ramp(a);
                    data[i] = r; data[i + 1] = g; data[i + 2] = b;
                    data[i + 3] = Math.round(255 * (+opacEl.value / 100) * Math.min(1, a * 1.5));
                }
                actx.putImageData(imgData, 0, 0);

                const blurPx = +blurEl.value;
                if (blurPx > 0) {
                    const tmp = document.createElement('canvas'); tmp.width = hw; tmp.height = hh;
                    const bctx = tmp.getContext('2d'); bctx.filter = `blur(${blurPx}px)`; bctx.drawImage(acc, 0, 0);
                    actx.clearRect(0, 0, hw, hh); actx.drawImage(tmp, 0, 0);
                }

                hctx.drawImage(acc, 0, 0, hw, hh, fit.x, fit.y, fit.w, fit.h);

                // QA markers - improved visibility
                fctx.fillStyle = '#0f172a'; // dark center
                fctx.strokeStyle = '#3b82f6'; // blue ring
                fctx.lineWidth = 1.5;
                for (const p of aggPoints) {
                    const mx = fit.x + p.x * sx;
                    const my = fit.y + p.y * sy;
                    fctx.beginPath(); fctx.arc(mx, my, 3, 0, Math.PI * 2); fctx.fill(); fctx.stroke();
                }

                updateCounts();
            }

            function makeKernelSprite(R) {
                const c = document.createElement('canvas'); c.width = c.height = R * 2;
                const ctx = c.getContext('2d');
                const g = ctx.createRadialGradient(R, R, 0, R, R, R);
                g.addColorStop(0, 'rgba(0,0,0,1)');
                g.addColorStop(0.3, 'rgba(0,0,0,0.35)');
                g.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = g; ctx.beginPath(); ctx.arc(R, R, R, 0, Math.PI * 2); ctx.fill();
                return c;
            }

            function ramp(t) {
                let x = Math.max(0, Math.min(1, t));
                x = Math.pow(x, 1);
                const G = [0, 255, 0];
                const Y = [255, 255, 0];
                const O = [255, 165, 0];
                const R = [255, 0, 0];

                const lerp = (a, b, p) => Math.round(a + (b - a) * p);
                let c;
                if (x < 0.5) {
                    const p = x / 0.5; 
                    c = [lerp(G[0], Y[0], p), lerp(G[1], Y[1], p), lerp(G[2], Y[2], p)];
                } else if (x < 0.75) {
                    const p = (x - 0.5) / 0.25;
                    c = [lerp(Y[0], O[0], p), lerp(Y[1], O[1], p), lerp(Y[2], O[2], p)];
                } else {
                    const p = (x - 0.75) / 0.25;
                    c = [lerp(O[0], R[0], p), lerp(O[1], R[1], p), lerp(O[2], R[2], p)];
                }
                return c;
            }

            function updateCounts() {
                let total = 0;
                FLOORS.forEach(fl => {
                    let n = fl.points.length;
                    for (const sess of filteredSessions()) {
                        const sf = (sess.floors || []).find(f => f.id === fl.id);
                        if (sf && Array.isArray(sf.points)) n += sf.points.length;
                    }
                    total += n;
                    const el = document.getElementById(`count-${fl.id}`);
                    if (el) el.textContent = n;
                });
                const t = document.getElementById('totalCount');
                if (t) t.textContent = total;
            }

            function persist() {
                const minimal = FLOORS.map(fl => ({ id: fl.id, points: fl.points }));
                localStorage.setItem('multi-floor-heatmap-embedded', JSON.stringify(minimal));
            }
            function restore() {
                try {
                    const arr = JSON.parse(localStorage.getItem('multi-floor-heatmap-embedded') || "[]");
                    arr.forEach((o, i) => { if (FLOORS[i]) FLOORS[i].points = o.points || []; });
                } catch { }
            }

            function toLocalDT(d) {
                const pad = n => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

            restore();
            fitCanvas();
            redraw();
        })();

        // --- Panel Toggle Logic ---
        const menuBtn = document.getElementById('menuBtn');
        const controlsPanel = document.getElementById('controlsPanel');

        function openPanel() { controlsPanel.removeAttribute('hidden'); menuBtn.setAttribute('aria-expanded', 'true'); }
        function closePanel() { controlsPanel.setAttribute('hidden', ''); menuBtn.setAttribute('aria-expanded', 'false'); }

        menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const willHide = !controlsPanel.hasAttribute('hidden');
            controlsPanel.toggleAttribute('hidden', willHide);
            menuBtn.setAttribute('aria-expanded', String(!willHide));
        });

        document.addEventListener('click', (e) => {
            if (!controlsPanel.hasAttribute('hidden') &&
                !controlsPanel.contains(e.target) &&
                e.target !== menuBtn) closePanel();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !controlsPanel.hasAttribute('hidden')) closePanel();
        });
    </script>
</body>
</html>